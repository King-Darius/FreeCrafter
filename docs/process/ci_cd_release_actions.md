# CI/CD Guard Rails for FreeCrafter Releases

This document lists the **exact** automated actions that guarantee FreeCrafter
is built, exercised, and packaged into a Windows `.exe` before a release goes
out. Follow the order below when auditing the pipeline or introducing new
checks.

## 1. Pull Request and Commit Gates

A merged change must have passed the full GitHub Actions workflow defined in
`.github/workflows/ci.yml`.

1. **Matrix build (`build-and-test` job).**
   - **Operating systems:** `ubuntu-latest`, `windows-latest`.
   - **Qt provisioning:** `jurplel/install-qt-action@v3` installs Qt 6.6.1 +
     SVG module; the action exports both POSIX and Windows prefixes to
     `QT_PREFIX_*` environment variables.
   - **Configure:** CMake generates Ninja (Linux) or VS 17 x64 (Windows) builds
     with `FREECRAFTER_ENABLE_ASSIMP=OFF`, `FREECRAFTER_ENABLE_ODA=OFF`.
   - **Build:** `cmake --build build --config Release --parallel`.
   - **Tests (Linux):** `scripts/run_tests_with_qt_env.sh --ctest` executes all
     CTest suites headlessly (`QT_QPA_PLATFORM=offscreen`).
   - **Tests (Windows):** Sets up Qt plugin paths, then runs
     `ctest --output-on-failure -C Release`.
2. **Static analysis (`clang-tidy` job).**
   - Reuses the bootstrapped Qt prefix (QT_PREFIX_POSIX).
   - Configures CMake with `-DCMAKE_EXPORT_COMPILE_COMMANDS=ON`.
   - Compiles to populate the compilation database.
   - Executes `run-clang-tidy -p build` over the tree.
3. **Packaging smoke test (`windows-package-smoke` job).**
   - Runs after `build-and-test`.
   - Installs NSIS and reuses the Qt prefix detected by `scripts/bootstrap.py`.
   - Builds a Release configuration, installs into `dist/`, runs `cpack -G NSIS`,
     and asserts that an installer `.exe` exists (`Verify packaged artifacts`
     step). Failure of this job blocks merges.
4. **Personal path scan (`personal-path-scan` job).**
   - Executes `scripts/tools/repo_guard.py` to guard against
     committing local user directories such as `C:\Users\<user>` or
     `/home/<user>`.

> **Result:** Every commit merged into `main` has compiled binaries, a passing
> CTest suite, clang-tidy coverage, and a validated Windows packaging dry run.

## 2. Release Tags (`release.yml`)

Tag pushes (`v*`) trigger a full matrix packaging workflow.

Before the numbered steps run, the workflow executes `python scripts/tools/repo_guard.py` to ensure no user-specific paths are tracked.

1. **Bootstrap + dependency install** for Linux, macOS, Windows runners.
2. **Configure** via `python scripts/bootstrap.py --ci`. On Windows, injects the
   NSIS path for CPack.
3. **Build** `cmake --build build --config Release`.
4. **Install** into `dist/` so runtime assets mirror shipping layout.
5. **Package with CPack.**
   - Linux: `cpack -G TGZ`
   - macOS: `cpack -G DragNDrop`
   - Windows: `cpack -G NSIS`
6. **Collect release artifacts** while checking for Windows installers. If the
   NSIS generator does not emit an `.exe`, the fallback script
   `scripts/package_gui_bootstrap.py` reruns packaging and the step fails if no
   installer appears.
7. **Upload**: Artifacts go both to the workflow run and the GitHub Release page.

## 3. Windows Release Track (`release-windows.yml`)

Windows-only tags run an additional, more granular workflow.

As an upfront guard, `python scripts/tools/repo_guard.py` runs before build steps start.

1. **Dependencies:** Installs Python 3.11 and NSIS.
2. **Configure:** `scripts/bootstrap.py --ci` (falls back to plain CMake) to
   ensure Qt is provisioned and the project is configured in Release mode.
3. **Build + install:** `cmake --build build --config Release`, then
   `cmake --install build --config Release --prefix dist`.
4. **Test suite:** Executes `ctest --output-on-failure -C Release` from the
   build tree with Qt paths on `PATH`.
5. **Package:** Runs `cpack -G NSIS`.
6. **Verify installer (`Verify packaged artifacts` step):**
   - Scans both `build` and `dist` directories for `*.exe`.
   - Dumps a manifest of discovered files.
   - Fails the workflow if no installer is found.
7. **Upload to GitHub Release:** Uses `svenstaro/upload-release-action` with
   glob matching to push every `.exe` generated by CPack.

> **Bottom line:** A release tag cannot complete unless a Windows `.exe`
> exists and all CTest suites pass in the shipping configuration.

## 4. Manual Sign-off

Before publishing release notes:

1. Open `docs/release_validation.md` and perform the clean-VM installer checks.
2. Record hash digests and validation dates in the release notes or checklist.
3. Attach the CI run URL to the release issue to document automated coverage.

Keep this document in sync with any CI changes so the automation contract stays
transparent. When adding new tools or platforms, extend the relevant sections
and reference the workflow step names.

